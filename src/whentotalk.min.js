cities=[]
currentTime=0;MAX_INT_LEN=24;MIN_INT_LEN=0;PERSON_CNT=4;persons=new Array();var Interval=function(start,end,offset,zoneObj){this.start=start;this.end=end;this.offset=offset;this.zoneObj=zoneObj;}
Interval.prototype.getUTCIntervals=function(){var returnIntervals=new Array();var start=this.start-this.offset;var end=this.end-this.offset;start=(start+24)%24;end=(end+24)%24;if(end==0){end=24;}
if(start>end){returnIntervals.push(new Interval(start,24,this.offset,this.zoneObj));returnIntervals.push(new Interval(0,end,this.offset,this.zoneObj));}else{returnIntervals.push(new Interval(start,end,this.offset,this.zoneObj));}
return returnIntervals;};var Person=function(name,cityIdx,timeslider,resultbar,interval){this.name=name;this.cityIdx=cityIdx;this.timeslider=timeslider;this.resultbar=resultbar;this.interval=interval;}
Person.prototype.readInterval=function(){if(this.cityIdx<0){this.interval=null;}else{var range=this.timeslider.noUiSlider.get();var zone=moment.tz.zone(cities[this.cityIdx]);this.interval=new Interval(parseInt(range[0]),parseInt(range[1]),(zone.offset(currentTime)/-60.0),zone);}}
Person.prototype.displayResult=function(intervals){var convertedIntervals=new Array();var offset=this.interval.offset;for(var i=0;i<intervals.length;i++){var zone=moment.tz.zone(cities[this.cityIdx]);var newInterval=new Interval((intervals[i].start+offset+24)%24,(intervals[i].end+offset+24)%24,0,zone);if(newInterval.end==0){newInterval.end=24;}
convertedIntervals.push(newInterval);};convertedIntervals=sortIntervalArray(convertedIntervals);displayResult(this.resultbar,convertedIntervals);};function initialize(){currentTime=new Date().getTime();cities=moment.tz.names();for(var i=0;i<PERSON_CNT;i++){persons.push(new Person("person"+i,-1,null,$("#result-"+i),null));};installSelectize();installTimeSlider();}
function installTimeSlider(){$('.timeslider').each(function(idx,elem){noUiSlider.create(elem,{start:[12,18],step:1,behaviour:'drag-tap',margin:1,connect:true,tooltips:[wNumb({decimals:0,edit:timesliderHandleEdit,undo:timesliderHandleUndo}),wNumb({decimals:0,edit:timesliderHandleEdit,undo:timesliderHandleUndo})],range:{'min':0,'max':24},pips:{mode:'values',values:[0,3,6,9,12,15,18,21,24],density:4,stepped:true}});persons[idx].timeslider=elem;elem.noUiSlider.on('update',function(){persons[idx].readInterval();calculateConversation();});});}
function installSelectize(){$(".city-select").each(function(idx,elem){$(elem).append($("<option></option>").attr("value",-1).text("-"));for(var i=0;i<cities.length;i++){$(elem).append($("<option></option>").attr("value",i).text(cities[i]));};persons[idx].select=$(elem).selectize({create:false,sortField:'text',onChange:function(value){persons[idx].cityIdx=value;if(value==-1){clearBar(persons[idx].resultbar);}
persons[idx].readInterval();calculateConversation();}});});}
function timesliderHandleEdit(value) {var newValue=parseInt(value);var rest=newValue-Math.floor(newValue);return newValue+":"+((rest*60)/10)+((rest*60)%10);}
function timesliderHandleUndo(value) {var parts=value.split(":");return parseInt(value[0])+parseInt(value[1])/60.0;}
function calculateConversation(){cnt=0;for(var i=0;i<persons.length;i++){if(persons[i].cityIdx!=-1) {cnt++;}};if(cnt<2){return;}
var permutations=makeCombinations();var resultIntervals=new Array();for(var i=0;i<permutations.length;i++){var minMax=findMinMax(permutations[i]);if(minMax!=null&&minMax.start<minMax.end){resultIntervals.push(minMax);}};resultIntervals=sortIntervalArray(resultIntervals);for(var i=0;i<persons.length;i++){if(persons[i].cityIdx!=-1) {persons[i].displayResult(resultIntervals);}};}
function sortIntervalArray(intervals){var minIdx;for(var i=0;i<intervals.length;i++){minIdx=i;for(var j=i+1;j<intervals.length;j++){if(intervals[j].start<intervals[minIdx].start){minIdx=j;}};var tmp=intervals[i];intervals[i]=intervals[minIdx];intervals[minIdx]=tmp;};return intervals;}
function makeCombinations(){var allIntervals=new Array();for(var i=0;i<persons.length;i++){if(persons[i].cityIdx!=-1){allIntervals.push(persons[i].interval.getUTCIntervals());}};return cartProd.apply(this,allIntervals);}
function cartProd(paramArray){function addTo(curr,args){var i,copy,rest=args.slice(1),last=!rest.length,result=[];for(i=0;i<args[0].length;i++){copy=curr.slice();copy.push(args[0][i]);if(last){result.push(copy);}else{result=result.concat(addTo(copy,rest));}}
return result;}
return addTo([],Array.prototype.slice.call(arguments));}
function findMinMax(intervals){var result=new Interval(-1,-1,0,null);var min=0-1;var max=24+1;for(var i=0;i<intervals.length;i++){if(intervals[i].start>min){min=intervals[i].start;result.start=min;}
if(intervals[i].end<max){max=intervals[i].end;result.end=max;}};return(result.start==-1||result.end==-1?null:result);}
function displayResult(bar,intervals){clearBar(bar);var current=0;for(var i=0;i<intervals.length;i++){if(current<intervals[i].start){paintBar(bar,"progress-bar-danger",intervals[i].start-current,false);current=intervals[i].start;}
paintBar(bar,"progress-bar-success",intervals[i].end-current,false);current=intervals[i].end;};if(current<MAX_INT_LEN){paintBar(bar,"progress-bar-danger",MAX_INT_LEN-current,false);}}
function paintBar(bar,color,width,text){widthString=((width/MAX_INT_LEN)*100)+"%";$(bar).append($("<div></div>").attr("class","progress-bar "+color).attr("style","width:"+widthString).text((text?width+"h":"")));}
function clearBar(bar){$(bar).empty();}